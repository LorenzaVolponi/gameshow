<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Host - Conselheiro vs M√°quina</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .status {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    .status-info {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    .question-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      resize: vertical;
      min-height: 80px;
    }
    .char-count {
      text-align: right;
      color: #666;
      font-size: 12px;
      margin-bottom: 15px;
    }
    .char-count.warning {
      color: #e53e3e;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-success {
      background: #48bb78;
      color: white;
    }
    .btn-success:hover {
      background: #38a169;
    }
    .btn-danger {
      background: #f56565;
      color: white;
    }
    .btn-danger:hover {
      background: #e53e3e;
    }
    .btn-warning {
      background: #ed8936;
      color: white;
    }
    .btn-warning:hover {
      background: #dd6b20;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    .section h3 {
      margin-bottom: 15px;
      color: #2d3748;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .question-item {
      margin-bottom: 20px;
    }
    .question-label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      display: block;
    }
    .groups-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    .group-badge {
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      background: #edf2f7;
      color: #4a5568;
    }
    .group-badge.active {
      background: #48bb78;
      color: white;
    }
    .response-item {
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #e2e8f0;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .response-label {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ia-badge {
      background: #ed8936;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
    }
    .human-badge {
      background: #48bb78;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
    }
    .reveal-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px solid #667eea;
    }
    .reveal-box h4 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 20px;
      text-align: center;
    }
    .finished {
      text-align: center;
      padding: 40px;
      background: #48bb78;
      color: white;
      border-radius: 12px;
      font-size: 24px;
      font-weight: bold;
    }
    .navigation-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ Conselheiro vs M√°quina</h1>
    <p class="subtitle">Painel de Controle do Host</p>

    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
      <a href="qr.html" target="_blank" style="text-decoration: none;">
        <button class="btn btn-primary">üì± QR Codes Grupos</button>
      </a>
    </div>

    <div class="status">
      <div class="status-info" id="statusInfo">Aguardando configura√ß√£o...</div>
      <div id="questionPreview"></div>
    </div>

    <!-- TELA DE CONFIGURA√á√ÉO -->
    <div id="controlsConfig">
      <div class="section">
        <h3>‚öôÔ∏è Configurar 4 Perguntas do Jogo</h3>
        
        <div class="question-item">
          <label class="question-label">Pergunta 1:</label>
          <textarea id="q1Input" class="question-input" placeholder="Digite a primeira pergunta..." maxlength="500" oninput="updateCharCount('q1Input', 'charCount1')"></textarea>
          <div id="charCount1" class="char-count">0 / 500 caracteres</div>
        </div>

        <div class="question-item">
          <label class="question-label">Pergunta 2:</label>
          <textarea id="q2Input" class="question-input" placeholder="Digite a segunda pergunta..." maxlength="500" oninput="updateCharCount('q2Input', 'charCount2')"></textarea>
          <div id="charCount2" class="char-count">0 / 500 caracteres</div>
        </div>

        <div class="question-item">
          <label class="question-label">Pergunta 3:</label>
          <textarea id="q3Input" class="question-input" placeholder="Digite a terceira pergunta..." maxlength="500" oninput="updateCharCount('q3Input', 'charCount3')"></textarea>
          <div id="charCount3" class="char-count">0 / 500 caracteres</div>
        </div>

        <div class="question-item">
          <label class="question-label">Pergunta 4:</label>
          <textarea id="q4Input" class="question-input" placeholder="Digite a quarta pergunta..." maxlength="500" oninput="updateCharCount('q4Input', 'charCount4')"></textarea>
          <div id="charCount4" class="char-count">0 / 500 caracteres</div>
        </div>

        <button class="btn btn-success" onclick="saveAndStartGame()">‚úÖ Salvar e Iniciar Jogo</button>
      </div>
    </div>

    <!-- TELA DE JOGO -->
    <div id="controlsGame" style="display: none;">
      <div class="section">
        <h3>üìù Grupos que responderam</h3>
        <div class="groups-list" id="groupsList">
          <div class="group-badge">G1</div>
          <div class="group-badge">G2</div>
          <div class="group-badge">G3</div>
          <div class="group-badge">G4</div>
          <div class="group-badge">G5</div>
          <div class="group-badge">G6</div>
          <div class="group-badge">G7</div>
          <div class="group-badge">G8</div>
          <div class="group-badge">G9</div>
        </div>
      </div>

      <div class="section">
        <h3>üìã Respostas da Pergunta</h3>
        <div id="responsesDisplay" style="margin-bottom: 15px;">
          <div style="color: #666; font-style: italic;">Aguardando respostas dos grupos...</div>
        </div>
        <button class="btn btn-warning" onclick="generateIA()" id="btnGenerateIA">‚ö° Gerar Resposta da IA</button>
      </div>

      <div class="section">
        <h3>üëÅÔ∏è Revelar Resultados</h3>
        <button class="btn btn-danger" onclick="revealCurrent()" id="btnReveal">Revelar IA vs Humano</button>
        <div id="revealDisplay" style="margin-top: 15px;"></div>
      </div>

      <div class="section">
        <h3>üîÑ Navega√ß√£o</h3>
        <div class="navigation-buttons">
          <button class="btn btn-primary" onclick="previousQuestion()" id="btnPrevious">‚óÄ Pergunta Anterior</button>
          <button class="btn btn-primary" onclick="nextQuestion()" id="btnNext">Pr√≥xima Pergunta ‚ñ∂</button>
        </div>
      </div>
    </div>

    <!-- TELA FINAL -->
    <div id="finishedScreen" style="display: none;">
      <div class="finished">
        üéâ Jogo Finalizado! Todas as 4 perguntas foram completadas.
      </div>
    </div>
  </div>

  <script>
    const ROOM = 'default';
    const API_BASE = window.location.origin;
    let pollingInterval;
    let currentState = {};
    let isFetching = false;

    function updateCharCount(textareaId, counterId) {
      const textarea = document.getElementById(textareaId);
      const counter = document.getElementById(counterId);
      const length = textarea.value.length;
      const maxLength = textarea.maxLength;
      counter.textContent = `${length} / ${maxLength} caracteres`;
      counter.className = length > maxLength * 0.9 ? 'char-count warning' : 'char-count';
    }

    async function fetchState() {
      if (isFetching) return;
      
      isFetching = true;
      try {
        const res = await fetch(`${API_BASE}/api/state?room=${ROOM}`);
        const data = await res.json();
        currentState = data;
        updateUI(data);
      } catch (err) {
        console.error('Error fetching state:', err);
      } finally {
        isFetching = false;
      }
    }

    function updateUI(state) {
      const statusInfo = document.getElementById('statusInfo');
      const questionPreview = document.getElementById('questionPreview');
      const controlsConfig = document.getElementById('controlsConfig');
      const controlsGame = document.getElementById('controlsGame');
      const finishedScreen = document.getElementById('finishedScreen');

      if (state.currentQuestion === -1) {
        statusInfo.textContent = 'Aguardando configura√ß√£o...';
        questionPreview.textContent = '';
        controlsConfig.style.display = 'block';
        controlsGame.style.display = 'none';
        finishedScreen.style.display = 'none';
      } else if (state.currentQuestion > 3) {
        controlsConfig.style.display = 'none';
        controlsGame.style.display = 'none';
        finishedScreen.style.display = 'block';
      } else {
        const questionNum = state.currentQuestion + 1;
        statusInfo.textContent = `Pergunta ${questionNum} de 4`;
        const currentQuestion = state.questions[state.currentQuestion] || '';
        questionPreview.innerHTML = `<strong>Pergunta:</strong> ${currentQuestion}`;
        controlsConfig.style.display = 'none';
        controlsGame.style.display = 'block';
        finishedScreen.style.display = 'none';

        updateGroupsList(state);
        updateResponsesDisplay(state);
        updateRevealDisplay(state);
        updateNavigationButtons(state);
      }
    }

    function updateGroupsList(state) {
      const groups = ['G1', 'G2', 'G3', 'G4', 'G5', 'G6', 'G7', 'G8', 'G9'];
      const groupsList = document.getElementById('groupsList');
      const questionKey = `q${state.currentQuestion}`;
      const responses = state.responses[questionKey] || {};

      groupsList.innerHTML = groups.map(g => {
        const hasResponse = responses[g];
        return `<div class="group-badge ${hasResponse ? 'active' : ''}">${g}</div>`;
      }).join('');
    }

    function updateResponsesDisplay(state) {
      const questionKey = `q${state.currentQuestion}`;
      const responses = state.responses[questionKey] || {};
      const hasResponses = Object.keys(responses).filter(k => k !== 'IA').length > 0;
      const hasIA = responses.IA;
      
      let html = '';

      if (hasResponses || hasIA) {
        if (hasResponses) {
          html += '<div style="margin-bottom: 15px;"><strong style="color: #48bb78;">üë• Respostas dos Grupos:</strong></div>';
          Object.entries(responses).forEach(([key, response]) => {
            if (key !== 'IA') {
              html += `
                <div class="response-item">
                  <div class="response-label">
                    <span>${key}</span>
                    <span class="human-badge">Humano</span>
                  </div>
                  <div style="color: #4a5568; line-height: 1.6;">${response}</div>
                </div>
              `;
            }
          });
        }
        
        if (hasIA) {
          html += '<div style="margin: 20px 0 10px 0;"><strong style="color: #ed8936;">ü§ñ Resposta da IA:</strong></div>';
          html += `
            <div class="response-item">
              <div class="response-label">
                <span>Groq LLaMA 3.1</span>
                <span class="ia-badge">IA</span>
              </div>
              <div style="color: #4a5568; line-height: 1.6;">${responses.IA}</div>
            </div>
          `;
        }
        
        document.getElementById('responsesDisplay').innerHTML = html;
      } else {
        document.getElementById('responsesDisplay').innerHTML = '<div style="color: #666; font-style: italic;">Aguardando respostas dos grupos...</div>';
      }
    }

    function updateRevealDisplay(state) {
      const questionKey = `q${state.currentQuestion}`;
      const revealed = state.revealed[questionKey];
      
      if (!revealed) {
        document.getElementById('revealDisplay').innerHTML = '';
        return;
      }

      const responses = state.responses[questionKey] || {};
      let html = '<div class="reveal-box">';
      html += '<h4>üéØ Resultados da Pergunta</h4>';

      Object.entries(responses).forEach(([key, response]) => {
        const isIA = key === 'IA';
        const badge = isIA ? '<span class="ia-badge">ü§ñ IA</span>' : `<span class="human-badge">üë• ${key}</span>`;
        
        html += `<div class="response-item">`;
        html += `<div class="response-label">${badge}</div>`;
        html += `<div style="color: #4a5568; line-height: 1.6;">${response || '<em>Sem resposta</em>'}</div>`;
        html += `</div>`;
      });

      html += '</div>';
      document.getElementById('revealDisplay').innerHTML = html;
    }

    function updateNavigationButtons(state) {
      const btnPrevious = document.getElementById('btnPrevious');
      const btnNext = document.getElementById('btnNext');

      btnPrevious.disabled = state.currentQuestion === 0;

      if (state.currentQuestion === 3) {
        btnNext.textContent = 'Finalizar Jogo ‚úì';
        btnNext.disabled = false;
      } else {
        btnNext.textContent = 'Pr√≥xima Pergunta ‚ñ∂';
        btnNext.disabled = false;
      }
    }

    async function updateState(updates) {
      try {
        const res = await fetch(`${API_BASE}/api/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ room: ROOM, updates })
        });
        const data = await res.json();
        if (data.success) {
          await fetchState();
        }
      } catch (err) {
        console.error('Error updating state:', err);
      }
    }

    async function saveAndStartGame() {
      const q1 = document.getElementById('q1Input').value.trim();
      const q2 = document.getElementById('q2Input').value.trim();
      const q3 = document.getElementById('q3Input').value.trim();
      const q4 = document.getElementById('q4Input').value.trim();

      if (!q1 || !q2 || !q3 || !q4) {
        alert('Por favor, preencha todas as 4 perguntas antes de iniciar o jogo.');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            room: ROOM, 
            updates: {
              questions: [q1, q2, q3, q4],
              currentQuestion: 0
            }
          })
        });

        const data = await res.json();
        if (data.success) {
          const clearRes = await fetch(`${API_BASE}/api/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              room: ROOM, 
              updates: {
                responses: {
                  q0: {},
                  q1: {},
                  q2: {},
                  q3: {}
                },
                revealed: {
                  q0: false,
                  q1: false,
                  q2: false,
                  q3: false
                }
              }
            })
          });

          if (clearRes.ok) {
            await fetchState();
            alert('‚úÖ Jogo iniciado! Aguarde as respostas dos grupos.');
          }
        }
      } catch (err) {
        console.error('Error starting game:', err);
        alert('‚ùå Erro ao iniciar jogo. Tente novamente.');
      }
    }

    async function generateIA() {
      const btn = document.getElementById('btnGenerateIA');
      btn.disabled = true;
      btn.textContent = '‚è≥ Gerando IA (pode levar alguns segundos)...';

      try {
        const currentQuestion = currentState.questions[currentState.currentQuestion];
        const res = await fetch(`${API_BASE}/api/ia`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            room: ROOM, 
            question: currentQuestion,
            saveToState: true
          })
        });

        const data = await res.json();
        
        if (data.success) {
          await fetchState();
          alert('‚úÖ IA gerada com sucesso!');
        } else {
          alert('‚ùå Erro: ' + (data.error || 'Erro ao gerar IA'));
        }
      } catch (err) {
        console.error('Error generating IA:', err);
        alert('‚ùå Erro ao gerar IA. Verifique sua conex√£o e tente novamente.');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ö° Gerar Resposta da IA';
      }
    }

    async function revealCurrent() {
      const questionKey = `q${currentState.currentQuestion}`;
      const responses = currentState.responses[questionKey] || {};
      
      if (Object.keys(responses).length === 0) {
        alert('N√£o h√° respostas para revelar ainda!');
        return;
      }

      await updateState({
        revealed: {
          ...currentState.revealed,
          [questionKey]: true
        }
      });

      alert('üëÅ Resultados revelados!');
    }

    async function nextQuestion() {
      if (currentState.currentQuestion >= 3) {
        await updateState({ currentQuestion: 4 });
        alert('üéâ Jogo finalizado!');
        return;
      }

      await updateState({ 
        currentQuestion: currentState.currentQuestion + 1 
      });
    }

    async function previousQuestion() {
      if (currentState.currentQuestion > 0) {
        await updateState({ 
          currentQuestion: currentState.currentQuestion - 1 
        });
      }
    }

    fetchState();
    pollingInterval = setInterval(fetchState, 500);
  </script>
</body>
</html>
